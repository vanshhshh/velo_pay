generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

enum WalletType {
  USER
  ESCROW
}

enum TransactionType {
  ONRAMP
  OFFRAMP
  INTERNAL
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  name      String
  googleId  String     @unique
  status    UserStatus @default(ACTIVE)
  currency  String     @default("USD")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  wallet               Wallet?
  sentTransactions     Transaction[] @relation("SentTransactions")
  receivedTransactions Transaction[] @relation("ReceivedTransactions")
  auditLogs            AuditLog[]

  @@index([email])
  @@index([googleId])
  @@map("users")
}

model Wallet {
  id           String     @id @default(uuid())
  userId       String?    @unique
  type         WalletType
  address      String     @unique
  encryptedKey String
  balance      Decimal    @default(0) @db.Decimal(19, 2)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  user                 User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  sentTransactions     Transaction[] @relation("SenderWallet")
  receivedTransactions Transaction[] @relation("ReceiverWallet")

  @@index([userId])
  @@index([address])
  @@index([type])
  @@map("wallets")
}

model Transaction {
  id       String            @id @default(uuid())
  type     TransactionType
  status   TransactionStatus @default(PENDING)
  amount   Decimal           @db.Decimal(19, 2)
  currency String            @default("USD")

  senderWalletId   String?
  receiverWalletId String?

  senderUserId   String?
  receiverUserId String?

  bankDetails Json?

  transakOrderId   String?
  transakPayoutId  String? @unique
  transakSessionId String? @unique
  referenceId      String? @unique

  metadata      Json?
  failureReason String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  senderWallet   Wallet? @relation("SenderWallet", fields: [senderWalletId], references: [id])
  receiverWallet Wallet? @relation("ReceiverWallet", fields: [receiverWalletId], references: [id])
  senderUser     User?   @relation("SentTransactions", fields: [senderUserId], references: [id])
  receiverUser   User?   @relation("ReceivedTransactions", fields: [receiverUserId], references: [id])

  @@index([senderWalletId])
  @@index([receiverWalletId])
  @@index([senderUserId])
  @@index([receiverUserId])
  @@index([transakOrderId])
  @@index([transakSessionId])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  entity    String?
  entityId  String?
  changes   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model TransakWebhook {
  id          String    @id @default(uuid())
  eventType   String
  orderId     String?
  payload     Json
  processed   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([orderId])
  @@index([processed])
  @@index([createdAt])
  @@map("transak_webhooks")
}
